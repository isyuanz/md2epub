<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown to EPUB è½¬æ¢å™¨</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“š</text></svg>">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/marked@12.0.0/marked.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“š Markdown to EPUB è½¬æ¢å™¨</h1>
            <p>å°†æ‚¨çš„ Markdown æ–‡æ¡£å¿«é€Ÿè½¬æ¢ä¸ºç²¾ç¾çš„ EPUB ç”µå­ä¹¦</p>
        </div>

        <div class="main-content">
            <div class="content-wrapper">
                <div class="left-panel">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="bookTitle">ä¹¦ç±æ ‡é¢˜ *</label>
                            <input type="text" id="bookTitle" placeholder="è¯·è¾“å…¥ä¹¦ç±æ ‡é¢˜" required>
                        </div>
                        <div class="form-group">
                            <label for="bookAuthor">ä½œè€…å§“å *</label>
                            <input type="text" id="bookAuthor" placeholder="è¯·è¾“å…¥ä½œè€…å§“å" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>å°é¢å›¾ç‰‡ (å¯é€‰)</label>
                        <div class="upload-area" id="coverUploadArea">
                            <div class="upload-icon">ğŸ–¼ï¸</div>
                            <p>ç‚¹å‡»ä¸Šä¼ å°é¢å›¾ç‰‡</p>
                            <p style="color: #666;">JPG/PNG, å»ºè®® 600x800</p>
                        </div>
                        <input type="file" id="coverInput" accept="image/*" style="display: none;">
                    </div>
                </div>

                <div class="right-panel">
                    <div class="textarea-wrapper">
                        <div class="textarea-header">
                            <label for="markdownInput">Markdown å†…å®¹ *</label>
                            <button class="file-upload-btn" id="fileUploadBtn">
                                ğŸ“„ ä¸Šä¼ æ–‡ä»¶
                            </button>
                            <input type="file" id="fileInput" accept=".md,.markdown,.txt" style="display: none;">
                        </div>
                        <textarea id="markdownInput" placeholder="åœ¨æ­¤å¤„ç²˜è´´æˆ–è¾“å…¥æ‚¨çš„ Markdown å†…å®¹...

ç¤ºä¾‹ï¼š
# ç¬¬ä¸€ç« 
è¿™æ˜¯ç¬¬ä¸€ç« çš„å†…å®¹

## ç¬¬ä¸€èŠ‚  
è¿™é‡Œæ˜¯è¯¦ç»†å†…å®¹...

# ç¬¬äºŒç« 
ç¬¬äºŒç« å†…å®¹..."></textarea>
                    </div>
                </div>

            </div>

            <div class="button-group">
                <button class="btn" id="generateBtn">â¬‡ï¸ ç”Ÿæˆ EPUB</button>
            </div>

            <div id="statusMessage" class="status"></div>
        </div>

        <div class="footer">
            <p>&copy; 2024 å…ƒå­Channel - All rights reserved</p>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let coverFileId = null;
        
        // DOMå…ƒç´ 
        const elements = {
            bookTitle: document.getElementById('bookTitle'),
            bookAuthor: document.getElementById('bookAuthor'),
            markdownInput: document.getElementById('markdownInput'),
            fileInput: document.getElementById('fileInput'),
            coverInput: document.getElementById('coverInput'),
            coverUploadArea: document.getElementById('coverUploadArea'),
            fileUploadBtn: document.getElementById('fileUploadBtn'),
            generateBtn: document.getElementById('generateBtn'),
            statusMessage: document.getElementById('statusMessage')
        };

        // äº‹ä»¶ç›‘å¬å™¨
        function initializeEventListeners() {
            // æ–‡ä»¶ä¸Šä¼ 
            elements.fileUploadBtn.addEventListener('click', () => {
                elements.fileInput.click();
            });

            elements.fileInput.addEventListener('change', handleFileUpload);

            // å°é¢ä¸Šä¼ 
            elements.coverUploadArea.addEventListener('click', () => {
                elements.coverInput.click();
            });

            elements.coverInput.addEventListener('change', handleCoverUpload);

            // æŒ‰é’®äº‹ä»¶
            elements.generateBtn.addEventListener('click', generateEpub);

            // æ‹–æ‹½ä¸Šä¼ 
            setupDragAndDrop();
        }

        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            try {
                showStatus('æ­£åœ¨ä¸Šä¼ æ–‡ä»¶...', 'loading');
                
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    elements.markdownInput.value = result.content;
                    
                    // å¦‚æœæ ‡é¢˜ä¸ºç©ºï¼Œä½¿ç”¨æ–‡ä»¶å
                    if (!elements.bookTitle.value.trim()) {
                        elements.bookTitle.value = result.title;
                    }
                    
                    showStatus('æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼', 'success');
                } else {
                    showStatus(result.error, 'error');
                }
            } catch (error) {
                showStatus('ä¸Šä¼ å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // å°é¢ä¸Šä¼ å¤„ç†
        async function handleCoverUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            try {
                showStatus('æ­£åœ¨ä¸Šä¼ å°é¢...', 'loading');
                
                const response = await fetch('/api/upload_cover', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    coverFileId = result.cover_id;
                    
                    // æ›´æ–°ä¸Šä¼ åŒºåŸŸæ˜¾ç¤º
                    elements.coverUploadArea.innerHTML = `
                        <div class="upload-icon">âœ…</div>
                        <p>å·²é€‰æ‹©å°é¢: ${result.filename}</p>
                        <p style="font-size: 0.8em; color: #666;">ç‚¹å‡»é‡æ–°é€‰æ‹©</p>
                    `;
                    
                    showStatus('å°é¢ä¸Šä¼ æˆåŠŸï¼', 'success');
                } else {
                    showStatus(result.error, 'error');
                }
            } catch (error) {
                showStatus('å°é¢ä¸Šä¼ å¤±è´¥ï¼š' + error.message, 'error');
            }
        }


        // ç”ŸæˆEPUB
        async function generateEpub() {
            const title = elements.bookTitle.value.trim();
            const author = elements.bookAuthor.value.trim();
            const content = elements.markdownInput.value.trim();

            if (!title || !author || !content) {
                showStatus('è¯·å¡«å†™å®Œæ•´çš„ä¹¦ç±ä¿¡æ¯å’Œ Markdown å†…å®¹', 'error');
                return;
            }

            elements.generateBtn.disabled = true;
            
            try {
                showStatus('æ­£åœ¨ç”Ÿæˆ EPUB æ–‡ä»¶...', 'loading');

                const response = await fetch('/api/convert', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title,
                        author,
                        content,
                        cover_id: coverFileId
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showStatus('EPUB æ–‡ä»¶ç”ŸæˆæˆåŠŸï¼æ­£åœ¨ä¸‹è½½...', 'success');
                    
                    // è§¦å‘ä¸‹è½½
                    const downloadUrl = `/api/download/${result.download_id}`;
                    window.location.href = downloadUrl;
                } else {
                    showStatus(result.error, 'error');
                }
            } catch (error) {
                showStatus('ç”Ÿæˆå¤±è´¥ï¼š' + error.message, 'error');
            } finally {
                elements.generateBtn.disabled = false;
            }
        }

        // çŠ¶æ€æ˜¾ç¤º
        function showStatus(message, type) {
            elements.statusMessage.className = `status ${type}`;
            
            if (type === 'loading') {
                elements.statusMessage.innerHTML = `<span class="loading-spinner"></span>${message}`;
            } else {
                elements.statusMessage.innerHTML = message;
            }
            
            elements.statusMessage.style.display = 'block';
            
            if (type !== 'loading') {
                setTimeout(() => {
                    elements.statusMessage.style.display = 'none';
                }, 5000);
            }
        }

        // æ‹–æ‹½ä¸Šä¼ 
        function setupDragAndDrop() {
            const uploadAreas = [elements.coverUploadArea, elements.markdownInput];
            
            uploadAreas.forEach(area => {
                area.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    area.classList.add('dragover');
                });

                area.addEventListener('dragleave', () => {
                    area.classList.remove('dragover');
                });

                area.addEventListener('drop', (e) => {
                    e.preventDefault();
                    area.classList.remove('dragover');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        const file = files[0];
                        
                        if (area === elements.coverUploadArea) {
                            // å°é¢å›¾ç‰‡ä¸Šä¼ 
                            if (file.type.startsWith('image/')) {
                                elements.coverInput.files = files;
                                handleCoverUpload({target: {files: files}});
                            }
                        } else {
                            // Markdownæ–‡ä»¶ä¸Šä¼ 
                            if (file.name.match(/\.(md|markdown|txt)$/i)) {
                                elements.fileInput.files = files;
                                handleFileUpload({target: {files: files}});
                            }
                        }
                    }
                });
            });
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            console.log('ğŸ“š Markdown to EPUB è½¬æ¢å™¨å·²å°±ç»ª');
        });
    </script>
</body>
</html>